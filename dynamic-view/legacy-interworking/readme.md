#### Deploy Interworking Protocol Stub (iwstub)

####TO BE FINISHED

The main data flows to support the deployment of protocol stubs required to connect the Hyperty Runtime to a Legacy domain, is presented in the figure below and described in this section.

![Figure @runtime-deploy-protostub: Deploy Protocol Stub](deploy-iwstub.png)

Steps 1-3: The Interworking Protocol Stub (the term IWstub will used in this document) deployment can be intiated by the Core Runtime Sandbox (e.g. Runtime Registry) or from other sandbox (e.g. Application). The Interworking Protocol Stub deployment will be triggered by the deployment of an Hyperty which will interact with a Legacy Domain service or by some attempt from a local Hyperty to communicate with a legacy domain which requires that interworking Protocol Stub. The Runtime UA only downloads and deploys requested IWstub after checking in the Registry that there is no Protocol Stub available in the Hyperty Runtime. **The "p2pconfig" parameter is not used in Interworking Protosutbshould provided containing the remote [P2P Handler Stub](../../messaging-framework/p2p-msg-delivery,md)??**.

Steps 4 - 5: the Runtime UA is able to derive the URL to download the Protocol Stub descriptor from the domain URL (legacy-domain), since it is a well known URI defined in the reTHINK Architecture Interfaces [15]. The Legacy Domain must add a Catalogue and a Service backend to download the IWstub code. This role may not be played by the Legacy Domain itself by a Third organization which provide interoperability between reTHINK and the legacy service. In this case, the [descriptor](https://github.com/reTHINK-project/specs/tree/master/datamodel/core/hyperty-catalogue) of the protostub will include the attribute set to *true*.

Steps 6-7: The Runtime UA extracts protostubDownloadURL from the protostub descriptor and downloads the protostub source code from a back end server from where the Legacy Domain serves the IWstub code.

Steps 8 - 11: the new Protocol Stub is registered in the Runtime Registry, which allocates and returns the runtime address (RuntimeURL) for the new runtime component. Since the protostub only has to be reached by runtime components, the protostub URL can be generated by the Runtime Registry ensuring the URL is unique in the Runtime namespace. **Optionaly, the protostub is registered in the remote Domain Registry??**. In addition, the runtime Registry requests the runtime BUS to add its listener to receive events about the Protocol Stub status.

Steps 12-15: The Runtime UA instantiates a new sandbox through the Sandbox interface which is registered in the Registry. **Phase 2 New!** The `capabilities` input parameter (see RuntimeSandboxCapabilities type in [Runtime Descriptor](../../datamodel/core/hyperty-catalogue/readme.md#hyperty-runtime-descriptor)) is used to indicate capabilities required eg window capabilities.

Steps 16-18: The Runtime UA requests the new Legacy Domain sandbox to instantiate the protostub source code, extracting the configuration data from the protostub descriptor. 

Steps 19-20: These steps are exclusive of the IWstub and may be different depending on the Legacy Domain the IWstub interacts with. In the diagram an interconnection with a SIP network is proposed, but other pro. Please note that if the runtime is being executed in a browser there is a limitation in the types of protocols we can use to interact with the Legacy Domain since it is limited to use either Protocols over HTTP or Protocols over Websocket (e.g. [SIPoWS](https://tools.ietf.org/html/rfc7118) or [XMPPoWS](https://datatracker.ietf.org/doc/rfc7395/)).  

Steps 21-22: A listener is added to the Msg BUS in order to be able to send messages to the IWstub from the Core Runtime. The RuntimeUA notifies the Application that the IWstub has been correctly deployed.

The Runtime UA finishes the Protocol Stub deploy by adding in the runtime BUS the protostub listener to receive messages from the runtime.

Protocol stubs are connected by using credentials handled by the Core Runtime Identity Module which are detailed in the [Domain Login](../identity-management/domain-login.md).



Steps 23 - 24: 

Protocol Stub publishes its status (including events about when it is connected or disconnected) in its resource status. Components registered on the Protocol Stub status resources, like the Registry, are notified about the new protocol status.

Message to publish Protocol Stub Status

```
"id" : "1"
"type" : "UPDATE",
"from" : "hyperty-runtime://sp1/protostub/123",
"to" : "hyperty-runtime://sp1/protostub/123/status",

"body" : { "value" : "LIVE" }
```
